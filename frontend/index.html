<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoidCat RDC - Federal Grant Automation</title>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
        
        // Custom events for grant platform
        function trackGrantSearch(query, resultsCount) {
            gtag('event', 'grant_search', {
                search_term: query,
                results_count: resultsCount,
                event_category: 'engagement'
            });
        }
        
        function trackProposalGeneration(grantId) {
            gtag('event', 'proposal_generation', {
                grant_id: grantId,
                event_category: 'conversion'
            });
        }
        
        function trackUserRegistration(tier) {
            gtag('event', 'sign_up', {
                subscription_tier: tier,
                event_category: 'conversion'
            });
        }
        
        function trackUpgrade() {
            gtag('event', 'purchase', {
                event_category: 'conversion',
                value: 99
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Dark mode configuration for Tailwind CSS
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://js.stripe.com/v3/"></script>
    <meta name="description" content="AI-powered federal grant discovery and proposal automation for startups and small businesses">
    <meta name="keywords" content="federal grants, SBIR, STTR, grant automation, AI proposal generation">
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <div x-data="grantApp()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <!-- Mobile menu button -->
                    <button class="mr-3 md:hidden" @click="menuOpen = !menuOpen" aria-label="Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-label="Menu">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">VoidCat RDC</h1>
                    <p class="text-gray-600 dark:text-gray-300">Federal Grant Automation Platform</p>
                    <p class="text-sm text-green-600 dark:text-green-400 font-semibold">üöÄ Now Live - MVP Version</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Dark Mode Toggle -->
                    <button @click="toggleDarkMode()" 
                            aria-label="Toggle dark mode"
                            class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <svg x-show="!darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                        <svg x-show="darkMode" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </button>
                    <template x-if="!user">
                        <button @click="showRegister = true" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Get Started Free
                        </button>
                    </template>
                    <template x-if="user">
                        <div class="text-right">
                            <p class="text-sm text-gray-600 dark:text-gray-300">Welcome, <span x-text="user.name || user.email"></span></p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 capitalize">Tier: <span x-text="user.subscription_tier"></span></p>
                            <template x-if="user.subscription_tier === 'free'">
                                <div class="upgrade-section mt-2">
                                    <button @click="upgradeToProModal = true" 
                                            aria-label="Upgrade to Pro"
                                            class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-4 py-2 rounded-lg hover:from-purple-600 hover:to-blue-600 font-semibold shadow-lg transition-all transform hover:scale-105">
                                        ‚ú® Upgrade to Pro - $99/month
                                    </button>
                                    <p class="text-xs text-orange-600 dark:text-orange-400 mt-1 font-medium">
                                        <span x-text="user.usage_count || 0"></span>/1 free grants used
                                    </p>
                                </div>
                            </template>
                            <template x-if="user.subscription_tier === 'pro'">
                                <div class="mt-2">
                                    <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-sm font-semibold">
                                        ‚úÖ Pro Member
                                    </span>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
            <!-- Mobile dropdown nav -->
            <nav class="md:hidden mt-3" x-show="menuOpen" x-transition>
                <ul class="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg shadow-sm divide-y dark:divide-gray-700">
                    <li><a href="#features" class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-200">Features</a></li>
                    <li><a href="#demo" class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-200">Demo</a></li>
                    <li><a href="#pricing" class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-200">Pricing</a></li>
                    <li><a href="#login" class="block px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-gray-200">Login</a></li>
                </ul>
            </nav>
        </header>

        <!-- Search Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border dark:border-gray-700 p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 dark:text-white">üîç Search Grant Opportunities</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <input x-model="searchQuery" 
              placeholder="Search keywords (AI, defense, energy...)" aria-label="Search keywords"
                       class="border dark:border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 dark:text-white">
                <select x-model="selectedAgency" 
                        class="border dark:border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                    <option value="">All Agencies</option>
                    <option value="defense">Department of Defense</option>
                    <option value="nsf">National Science Foundation</option>
                    <option value="energy">Department of Energy</option>
                    <option value="darpa">DARPA</option>
                    <option value="nasa">NASA</option>
                </select>
                <button @click="searchGrants()" 
                        :disabled="loading"
                        class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50">
                    <span x-show="!loading">Search Grants</span>
                    <span x-show="loading">Searching...</span>
                </button>
            </div>
            <div x-show="grants.length > 0" class="text-sm text-gray-600 dark:text-gray-300">
                Found <span x-text="grants.length"></span> matching opportunities
                <span x-show="usingDemoData" class="ml-2 px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded text-xs font-medium">
                    üìã Demo Data (API unavailable)
                </span>
            </div>
        </div>        <!-- Registration Modal -->
        <div x-show="showRegister" 
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
             x-transition>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold mb-4 dark:text-white">üöÄ Register for Free Access</h3>
                <form @submit.prevent="register()">
                    <div class="space-y-4">
                        <input x-model="registerForm.name" 
                               placeholder="Full Name" 
                               required
                               class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                        <input x-model="registerForm.email" 
                               placeholder="Email Address" 
                               type="email"
                               required
                               class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                        <input x-model="registerForm.company" 
                               placeholder="Company Name (Optional)" 
                               class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-white">
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            Free tier includes 1 grant application per month. Upgrade for unlimited access.
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" 
                                    :disabled="registering"
                                    class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50">
                                <span x-show="!registering">Register</span>
                                <span x-show="registering">Registering...</span>
                            </button>
                            <button @click="showRegister = false" 
                                    type="button"
                                    class="flex-1 border border-gray-300 dark:border-gray-600 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-white">
                                Cancel
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Upgrade to Pro Modal -->
        <div x-show="upgradeToProModal" 
             class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
             x-transition>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl relative">
                <!-- Accessible Close button -->
                <button @click="upgradeToProModal = false" aria-label="Close"
                        class="absolute top-3 right-3 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                    ‚úñ
                </button>
                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">üöÄ</div>
                    <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Upgrade to Pro</h3>
                    <p class="text-gray-600 dark:text-gray-300">Unlock unlimited grant applications and AI-powered proposals</p>
                </div>
                <!-- Error alert for upgrade flow -->
                <div x-show="upgradeError" role="alert" class="mb-4 p-3 rounded bg-red-50 dark:bg-red-900 text-red-700 dark:text-red-200 border border-red-200 dark:border-red-700">
                    <strong>Upgrade failed:</strong> <span x-text="upgradeError"></span>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border dark:border-gray-600">
                        <h4 class="font-semibold text-gray-800 dark:text-white mb-2">üÜì Free Tier</h4>
                        <div class="space-y-1 text-sm text-gray-600 dark:text-gray-300">
                            <p>‚Ä¢ 1 grant application per month</p>
                            <p>‚Ä¢ Basic grant search</p>
                            <p>‚Ä¢ Limited proposal generation</p>
                            <p>‚Ä¢ Basic matching</p>
                            <p>‚Ä¢ Email support</p>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 dark:bg-blue-900 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900 dark:to-purple-900 p-4 rounded-lg border-2 border-blue-200 dark:border-blue-700">
                        <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">‚ú® Pro Tier - $99/month</h4>
                        <div class="space-y-1 text-sm text-blue-700 dark:text-blue-200">
                            <p>‚Ä¢ ‚úÖ <strong>Unlimited</strong> grant applications</p>
                            <p>‚Ä¢ ‚úÖ <strong>Advanced</strong> AI proposal generation</p>
                            <p>‚Ä¢ ‚úÖ <strong>Priority</strong> customer support</p>
                            <p>‚Ä¢ ‚úÖ <strong>Advanced</strong> analytics & insights</p>
                            <p>‚Ä¢ ‚úÖ <strong>Early access</strong> to new features</p>
                            <p>‚Ä¢ ‚úÖ <strong>Dedicated</strong> account <strong>manager</strong></p>
                        </div>
                        <div class="mt-3 p-2 bg-yellow-100 dark:bg-yellow-900 rounded text-center">
                            <p class="text-sm font-semibold text-yellow-800 dark:text-yellow-200">üí∞ ROI: Avg. $250K+ in grants won</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button @click="createCheckoutSession()" 
                            class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg hover:from-blue-700 hover:to-purple-700 font-semibold transition-all transform hover:scale-105 shadow-lg">
                        üöÄ Upgrade Now
                    </button>
                    <button @click="upgradeToProModal = false" 
                            class="flex-1 border border-gray-300 dark:border-gray-600 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors dark:text-white">
                        Maybe Later
                    </button>
                </div>
                
                <p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-4">
                    üí≥ Secure payment via Stripe ‚Ä¢ Cancel anytime
                </p>
            </div>
        </div>

        <!-- Usage Limit Reached Modal -->
        <div x-show="showUpgradePrompt" 
             class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
             x-transition>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-2">‚ö†Ô∏è</div>
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">Free Limit Reached!</h3>
                    <p class="text-gray-600 dark:text-gray-300">You've used your 1 free grant application this month</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">You've reached your free limit. Please upgrade to continue.</p>
                </div>
                
                <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg mb-6 border border-blue-200 dark:border-blue-700">
                    <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">üöÄ Upgrade to Pro for:</h4>
                    <div class="space-y-1 text-sm text-blue-700 dark:text-blue-200">
                        <p>‚Ä¢ <strong>Unlimited</strong> grant applications</p>
                        <p>‚Ä¢ <strong>Advanced</strong> AI proposal generation</p>
                        <p>‚Ä¢ <strong>Priority</strong> support</p>
                    </div>
                    <div class="mt-3 text-center">
                        <span class="bg-yellow-200 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 px-3 py-1 rounded-full text-sm font-bold">
                            Only $99/month
                        </span>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button @click="upgradeToProModal = true; showUpgradePrompt = false" 
                            class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
                        Upgrade Now
                    </button>
                    <button @click="showUpgradePrompt = false" 
                            class="flex-1 border border-gray-300 dark:border-gray-600 py-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-white">
                        Not Now
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Proposal Modal -->
        <div x-show="showProposalModal" 
             class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
             x-transition>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-2xl font-bold">üìù Generated Proposal</h3>
                            <p class="text-blue-100 mt-1" x-text="currentProposal?.grant_id ? `Grant ID: ${currentProposal.grant_id}` : 'AI-Generated Grant Proposal'"></p>
                        </div>
                        <button @click="showProposalModal = false" 
                                class="text-blue-100 hover:text-white text-2xl font-bold"
                                aria-label="Close">
                            √ó
                        </button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="p-6 overflow-y-auto max-h-[60vh]">
                    <div class="prose max-w-none">
                        <pre class="whitespace-pre-wrap text-gray-800 dark:text-gray-200 font-mono text-sm leading-relaxed bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border dark:border-gray-600" 
                             x-text="currentProposal?.proposal || currentProposal"></pre>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="bg-gray-50 dark:bg-gray-700 px-6 py-4 border-t dark:border-gray-600">
                    <div class="flex flex-wrap gap-3 justify-between items-center">
                        <div class="flex flex-wrap gap-3">
                            <button @click="exportProposalAsMarkdown()" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                üìÑ Export Markdown
                            </button>
                            <button @click="copyProposalToClipboard()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                üìã Copy to Clipboard
                            </button>
                        </div>
                        <div class="flex gap-3">
                            <button @click="showProposalModal = false" 
                                    class="border border-gray-300 dark:border-gray-600 px-4 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors dark:text-white">
                                Close
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600 dark:text-gray-300 mt-3">
                        üí° <strong>Tip:</strong> This is an AI-generated draft. Review and customize before submission.
                    </p>
                </div>
            </div>
        </div>

        <!-- Enhanced Grant Details Modal -->
        <div x-show="showGrantDetailsModal" 
             class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
             x-transition>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-2xl font-bold">üìã Grant Details</h3>
                            <p class="text-green-100 mt-1" x-text="currentGrantDetails?.agency || 'Federal Grant Opportunity'"></p>
                        </div>
                        <button @click="showGrantDetailsModal = false" 
                                class="text-green-100 hover:text-white text-2xl font-bold"
                                aria-label="Close">
                            √ó
                        </button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="p-6 overflow-y-auto max-h-[60vh]">
                    <template x-if="currentGrantDetails">
                        <div class="space-y-6">
                            <!-- Grant Title and Basic Info -->
                            <div>
                                <h4 class="text-xl font-bold text-gray-900 dark:text-white mb-2" x-text="currentGrantDetails.title"></h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="font-semibold text-gray-700 dark:text-gray-300">üèõÔ∏è Agency:</span>
                                        <span x-text="currentGrantDetails.agency" class="ml-2 dark:text-gray-200"></span>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-gray-700 dark:text-gray-300">üìù Program:</span>
                                        <span x-text="currentGrantDetails.program" class="ml-2 dark:text-gray-200"></span>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-gray-700 dark:text-gray-300">üìÖ Deadline:</span>
                                        <span x-text="formatDate(currentGrantDetails.deadline)" class="ml-2 dark:text-gray-200"></span>
                                    </div>
                                    <div>
                                        <span class="font-semibold text-gray-700 dark:text-gray-300">üí∞ Amount:</span>
                                        <span x-text="currentGrantDetails.amount" class="ml-2 font-bold text-green-600 dark:text-green-400"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div>
                                <h5 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">üìÑ Description:</h5>
                                <p class="text-gray-700 dark:text-gray-300 leading-relaxed" x-text="currentGrantDetails.description"></p>
                            </div>
                            
                            <!-- Eligibility -->
                            <div>
                                <h5 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">‚úÖ Eligibility:</h5>
                                <p class="text-gray-700 dark:text-gray-300" x-text="currentGrantDetails.eligibility"></p>
                            </div>
                            
                            <!-- Contact Information (if available) -->
                            <template x-if="currentGrantDetails.contact">
                                <div>
                                    <h5 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">üìû Contact Information:</h5>
                                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                                        <p class="dark:text-gray-200"><strong>Name:</strong> <span x-text="currentGrantDetails.contact.name"></span></p>
                                        <p class="dark:text-gray-200"><strong>Email:</strong> <span x-text="currentGrantDetails.contact.email"></span></p>
                                        <p class="dark:text-gray-200"><strong>Phone:</strong> <span x-text="currentGrantDetails.contact.phone"></span></p>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Matching Score -->
                            <div>
                                <h5 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">üéØ Match Score:</h5>
                                <div class="flex items-center">
                                    <div class="w-32 bg-gray-200 dark:bg-gray-700 rounded-full h-3 mr-3">
                                        <div class="bg-blue-600 h-3 rounded-full transition-all" 
                                             :style="`width: ${(currentGrantDetails.matching_score || 0) * 100}%`"></div>
                                    </div>
                                    <span class="text-sm font-semibold dark:text-gray-200" 
                                          x-text="`${Math.round((currentGrantDetails.matching_score || 0) * 100)}% match`"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Modal Footer -->
                <div class="bg-gray-50 dark:bg-gray-700 px-6 py-4 border-t dark:border-gray-600">
                    <div class="flex justify-between items-center">
                        <p class="text-xs text-gray-600 dark:text-gray-300">
                            üí° <strong>Tip:</strong> Click "Generate Proposal" to create an AI-powered application for this grant.
                        </p>
                        <div class="flex gap-3">
                            <template x-if="currentGrantDetails && user">
                                <button @click="generateProposal(currentGrantDetails.id); showGrantDetailsModal = false" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    ‚ú® Generate Proposal
                                </button>
                            </template>
                            <button @click="showGrantDetailsModal = false" 
                                    class="border border-gray-300 dark:border-gray-600 px-4 py-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors dark:text-white">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Modal -->
        <div x-show="showNotificationModal" 
             class="fixed top-4 right-4 z-60 max-w-sm"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-x-full"
             x-transition:enter-end="opacity-100 transform translate-x-0"
             x-transition:leave="transition ease-in duration-300"
             x-transition:leave-start="opacity-100 transform translate-x-0"
             x-transition:leave-end="opacity-0 transform translate-x-full">
            <div class="rounded-lg shadow-lg overflow-hidden"
                 :class="notificationType === 'success' ? 'bg-green-500' : 
                         notificationType === 'error' ? 'bg-red-500' : 
                         notificationType === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <span class="text-white text-xl"
                                  x-text="notificationType === 'success' ? '‚úÖ' : 
                                          notificationType === 'error' ? '‚ùå' : 
                                          notificationType === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'"></span>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-white font-medium" x-text="notificationMessage"></p>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            <button @click="showNotificationModal = false" 
                                    class="text-white hover:text-gray-200"
                                    aria-label="Close">
                                <span class="text-lg">√ó</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Modal -->
        <div x-show="showErrorModal" 
             class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
             x-transition>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-md w-full">
                <!-- Modal Header -->
                <div class="bg-red-600 text-white p-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            ‚ùå Error
                        </h3>
                        <button @click="showErrorModal = false" 
                                class="text-red-100 hover:text-white text-xl font-bold"
                                aria-label="Close">
                            √ó
                        </button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="p-6">
                    <p class="text-gray-700 dark:text-gray-300" x-text="errorMessage"></p>
                </div>
                
                <!-- Modal Footer -->
                <div class="bg-gray-50 dark:bg-gray-700 px-6 py-4 rounded-b-lg border-t dark:border-gray-600">
                    <div class="flex justify-end">
                        <button @click="showErrorModal = false" 
                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grant Results -->
        <div x-show="grants.length > 0" class="space-y-4">
            <template x-for="grant in grants" :key="grant.id">
                <div class="grant-card bg-white dark:bg-gray-800 rounded-lg shadow-sm border dark:border-gray-700 p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-1" x-text="grant.title"></h4>
                            <p class="text-gray-600 dark:text-gray-300 font-medium" x-text="grant.agency"></p>
                            <p class="text-sm text-gray-500 dark:text-gray-400" x-text="grant.program"></p>
                        </div>
                        <div class="text-right ml-4">
                            <p class="text-lg font-bold text-green-600 dark:text-green-400" x-text="grant.amount"></p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                üìÖ Deadline: <span x-text="formatDate(grant.deadline)"></span>
                            </p>
                            <div class="flex items-center mt-2">
                                <div class="w-16 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mr-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all" 
                                         :style="`width: ${grant.matching_score * 100}%`"></div>
                                </div>
                                <span class="text-xs text-gray-600 dark:text-gray-400" 
                                      x-text="`${Math.round(grant.matching_score * 100)}% match`"></span>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-gray-700 dark:text-gray-300 mb-4" x-text="grant.description"></p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        <strong>‚úÖ Eligibility:</strong> <span x-text="grant.eligibility"></span>
                    </p>
                    
                    <div class="flex flex-wrap gap-3">
                        <button @click="viewGrant(grant.id)" 
                                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors text-sm">
                            üìã View Details
                        </button>
                        <button @click="generateProposal(grant.id)" 
                                :disabled="!user"
                                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:bg-gray-400 transition-colors text-sm">
                            ü§ñ Generate Proposal
                        </button>
                        <button class="border border-gray-300 dark:border-gray-600 px-4 py-2 rounded hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm dark:text-white">
                            üíæ Save for Later
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- API Connection Error Banner -->
        <div x-show="apiConnectionError && usingDemoData"
             class="mb-6 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 p-4 rounded">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <span class="text-yellow-400 text-2xl">‚ö†Ô∏è</span>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-medium text-yellow-800 dark:text-yellow-200">
                        API Connection Issue
                    </h3>
                    <div class="mt-2 text-sm text-yellow-700 dark:text-yellow-300">
                        <p x-text="apiConnectionError"></p>
                        <p class="mt-2">The grant database is temporarily unavailable. You're seeing limited demo data. Please try refreshing the page in a few moments to access live federal grant data.</p>
                    </div>
                    <div class="mt-3">
                        <button @click="searchGrants(); apiConnectionError = null"
                                class="text-sm font-medium text-yellow-800 dark:text-yellow-200 underline hover:text-yellow-900 dark:hover:text-yellow-100">
                            Retry Connection
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600 dark:text-gray-400">Connecting to grant database...</p>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-500">Loading live federal grant opportunities</p>
        </div>

        <!-- Empty State -->
        <div x-show="!loading && grants.length === 0 && searchPerformed" 
             class="text-center py-12">
            <div class="text-gray-400 dark:text-gray-600 text-6xl mb-4">üìã</div>
            <h3 class="text-lg font-semibold text-gray-600 dark:text-gray-300 mb-2">No grants found</h3>
            <p class="text-gray-500 dark:text-gray-400">Try adjusting your search criteria or browse all opportunities.</p>
        </div>        <!-- Hero Section -->
        <div x-show="!searchPerformed" class="mt-8">
            <section class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-12 rounded-lg mb-12">
                <div class="container mx-auto text-center px-6">
                    <h1 class="text-4xl font-bold mb-4">Win More Federal Grants with AI</h1>
                    <p class="text-xl mb-6">20% success rate vs 10% industry average ‚Ä¢ $2.5M+ in client awards</p>
                    <div class="flex justify-center space-x-4 mb-6">
                        <button @click="showRegister = true" 
                                class="bg-white text-blue-600 px-8 py-3 rounded-lg font-bold hover:bg-gray-100 transition-colors">
                            Start Free Trial
                        </button>
                        <a href="#features" class="border border-white px-8 py-3 rounded-lg hover:bg-white hover:text-blue-600 transition-colors">See Features</a>
                        <a href="#demo" class="border border-white px-8 py-3 rounded-lg hover:bg-white hover:text-blue-600 transition-colors">Watch Demo</a>
                    </div>
                    <p class="text-sm opacity-90">‚úÖ No credit card required ‚Ä¢ ‚úÖ 1 free grant application</p>
                </div>
            </section>

            <!-- Social Proof Section -->
            <section class="py-12 bg-gray-50 dark:bg-gray-800 rounded-lg mb-8">
                <div class="container mx-auto text-center px-6">
                    <h2 class="text-2xl font-bold mb-8 dark:text-white">Trusted by Innovative Companies</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="bg-white dark:bg-gray-700 p-6 rounded-lg shadow">
                            <div class="text-3xl mb-2">üöÄ</div>
                            <h3 class="font-semibold dark:text-white">TechStartup AI</h3>
                            <p class="text-gray-600 dark:text-gray-300">"Won $250k SBIR in 3 weeks"</p>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-6 rounded-lg shadow">
                            <div class="text-3xl mb-2">üõ°Ô∏è</div>
                            <h3 class="font-semibold dark:text-white">DefenseTech Corp</h3>
                            <p class="text-gray-600 dark:text-gray-300">"Automated our entire grant process"</p>
                        </div>
                        <div class="bg-white dark:bg-gray-700 p-6 rounded-lg shadow">
                            <div class="text-3xl mb-2">üî¨</div>
                            <h3 class="font-semibold dark:text-white">Research Institute</h3>
                            <p class="text-gray-600 dark:text-gray-300">"Doubled our funding success rate"</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Features Section -->
            <h2 id="features" class="text-2xl font-semibold text-center mb-8 dark:text-white">Everything You Need to Win Grants</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm border dark:border-gray-700">
                    <div class="text-4xl mb-4">üéØ</div>
                    <h3 class="text-lg font-semibold mb-2 dark:text-white">AI-Powered Matching</h3>
                    <p class="text-gray-600 dark:text-gray-300">Automatically match your capabilities to the most relevant federal opportunities.</p>
                </div>
                <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm border dark:border-gray-700">
                    <div class="text-4xl mb-4">‚ö°</div>
                    <h3 class="text-lg font-semibold mb-2 dark:text-white">Proposal Generation</h3>
                    <p class="text-gray-600 dark:text-gray-300">Generate high-quality grant proposals in minutes using our AI assistant.</p>
                </div>
                <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm border dark:border-gray-700">
                    <div class="text-4xl mb-4">‚è±Ô∏è</div>
                    <h3 class="text-lg font-semibold mb-2 dark:text-white">Time Savings</h3>
                    <p class="text-gray-600 dark:text-gray-300">Save dozens of hours per application with streamlined workflows.</p>
                </div>
            </div>

            <!-- Demo Section -->
            <section id="demo" class="py-12 bg-white dark:bg-gray-800 rounded-lg mt-12 shadow-sm border dark:border-gray-700">
                <div class="container mx-auto text-center px-6">
                    <h2 class="text-2xl font-bold mb-4 dark:text-white">See It In Action</h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">Watch a quick walkthrough of searching grants and generating a proposal.</p>
                    <div class="w-full">
                        <iframe class="w-full h-64 md:h-96" src="https://www.youtube.com/embed/dQw4w9WgXcQ" title="VoidCat RDC Demo" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>
            </section>
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-500 dark:text-gray-400 text-sm">
            <p>&copy; 2025 VoidCat RDC. Federal Grant Automation Platform.</p>
            <p class="mt-1">Helping startups secure federal funding through AI-powered grant discovery and proposal generation.</p>
            <div class="mt-4 flex justify-center space-x-6">
                <a href="privacy-policy.html" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors">Privacy Policy</a>
                <a href="terms-of-service.html" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors">Terms of Service</a>
                <a href="mailto:support@voidcat.org" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors">Support</a>
            </div>
        </footer>
    </div>

    <script>
        // --- Crypto utilities for securing API key in localStorage ---
        // Uses AES-GCM and key derived from user's email as passphrase.
        async function getKeyMaterial(passphrase) {
            let enc = new TextEncoder();
            return await window.crypto.subtle.importKey(
                "raw",
                enc.encode(passphrase),
                "PBKDF2",
                false,
                ["deriveKey"]
            );
        }

        async function deriveKey(passphrase, salt) {
            const keyMaterial = await getKeyMaterial(passphrase);
            return await window.crypto.subtle.deriveKey(
                {
                    "name": "PBKDF2",
                    salt: salt,
                    "iterations": 100000,
                    "hash": "SHA-256"
                },
                keyMaterial,
                { "name": "AES-GCM", "length": 256},
                false,
                ["encrypt", "decrypt"]
            );
        }

        async function encryptString(text, passphrase) {
            let enc = new TextEncoder();
            // Generate random salt and IV
            let salt = window.crypto.getRandomValues(new Uint8Array(16));
            let iv = window.crypto.getRandomValues(new Uint8Array(12));
            let key = await deriveKey(passphrase, salt);
            let ciphertext = await window.crypto.subtle.encrypt(
                {
                    name: "AES-GCM",
                    iv: iv
                },
                key,
                enc.encode(text)
            );
            // Encode salt, iv, and ciphertext as base64
            let b64 = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
            return [
                b64(salt),
                b64(iv),
                b64(ciphertext)
            ].join(':');
        }

        async function decryptString(data, passphrase) {
            let [saltB64, ivB64, ciphertextB64] = data.split(':');
            if (!saltB64 || !ivB64 || !ciphertextB64) return null;
            let b64ToArr = (b64) => Uint8Array.from(atob(b64), c => c.charCodeAt(0));
            let salt = b64ToArr(saltB64);
            let iv = b64ToArr(ivB64);
            let ciphertext = b64ToArr(ciphertextB64);
            let key = await deriveKey(passphrase, salt);
            let dec = await window.crypto.subtle.decrypt(
                {
                    name: "AES-GCM",
                    iv: iv
                },
                key,
                ciphertext
            );
            return new TextDecoder().decode(dec);
        }

        // ... (crypto helpers above) ...

        function grantApp() {
            return {
                // State
                user: null,
                apiKey: null, // will be initialized async in init()
                grants: [],
                darkMode: false,
                // Async initialization (called automatically by Alpine.js)
                async init() {
                    // Initialize dark mode from localStorage
                    this.darkMode = localStorage.getItem('darkMode') === 'true';
                    this.applyDarkMode();
                    
                    // If user has provided email before, use as passphrase. Otherwise, static for demo.
                    let stored = localStorage.getItem('voidcat_api_key');
                    if (stored) {
                        try {
                            // We need a passphrase; try using the registerForm email or ask the user
                            let passphrase = this.registerForm?.email || (this.user?.email) || window.prompt("Enter your email to unlock stored credentials:");
                            if (!passphrase) return;
                            this.apiKey = await decryptString(stored, passphrase);
                        } catch (e) {
                            console.error("Error decrypting API key from storage", e);
                        }
                    }
                },
                
                // Dark mode methods
                toggleDarkMode() {
                    this.darkMode = !this.darkMode;
                    localStorage.setItem('darkMode', this.darkMode);
                    this.applyDarkMode();
                },
                
                applyDarkMode() {
                    if (this.darkMode) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },
                loading: false,
                registering: false,
                searchPerformed: false,
                showRegister: false,
                upgradeToProModal: false,
                showUpgradePrompt: false,
                usingDemoData: false,
                apiConnectionError: null, // Store API connection error message
                upgradeError: '',
                menuOpen: false,
                
                // New modal states for UX overhaul
                showProposalModal: false,
                showGrantDetailsModal: false,
                showNotificationModal: false,
                showErrorModal: false,
                
                // Modal content
                currentProposal: null,
                currentGrantDetails: null,
                notificationMessage: '',
                errorMessage: '',
                notificationType: 'success', // 'success', 'error', 'warning', 'info'
                
                // Form data
                searchQuery: '',
                selectedAgency: '',
                
                // Demo grants for fallback
                demoGrants: [
                    {
                        id: 'SBIR-25-001',
                        title: 'AI for Defense Applications',
                        agency: 'Department of Defense',
                        program: 'SBIR Phase I',
                        deadline: '2025-09-15',
                        amount: '$250,000',
                        description: 'Seeking innovative AI solutions for defense applications including autonomous systems, cybersecurity, and logistics optimization.',
                        eligibility: 'Small businesses with <500 employees',
                        matching_score: 0.95
                    },
                    {
                        id: 'DARPA-25-006',
                        title: 'Artificial Intelligence Next Campaign',
                        agency: 'DARPA',
                        program: 'AI Next',
                        deadline: '2025-03-15',
                        amount: '$5,000,000',
                        description: 'Revolutionary AI research for national security applications including autonomous systems, cybersecurity, and logistics optimization.',
                        eligibility: 'Research institutions and innovative companies',
                        matching_score: 0.91,
                        tags: ['AI', 'Machine Learning', 'Defense', 'Research']
                    },
                    {
                        id: 'NIH-25-007',
                        title: 'AI for Medical Diagnosis',
                        agency: 'National Institutes of Health',
                        program: 'STTR Phase II',
                        deadline: '2025-04-30',
                        amount: '$2,000,000',
                        description: 'Developing AI systems for early disease detection and personalized treatment recommendations.',
                        eligibility: 'Small businesses partnering with research institutions',
                        matching_score: 0.88,
                        tags: ['Healthcare', 'AI', 'Diagnostics', 'STTR']
                    },
                    {
                        id: 'DOE-25-008',
                        title: 'Smart Grid AI Optimization',
                        agency: 'Department of Energy',
                        program: 'Grid Modernization',
                        deadline: '2025-06-01',
                        amount: '$3,500,000',
                        description: 'AI-powered optimization of electrical grid systems for improved efficiency and renewable energy integration.',
                        eligibility: 'US companies with energy sector experience',
                        matching_score: 0.85,
                        tags: ['Energy', 'Smart Grid', 'AI', 'Infrastructure']
                    }
                ],
                registerForm: {
                    name: '',
                    email: '',
                    company: ''
                },

                // API Configuration - Environment-aware for testing and production
                apiBase: (() => {
                    // Check for test environment flag
                    const params = new URLSearchParams(window.location.search);
                    const isTestMode = params.has('test_api') || params.get('api_mode') === 'local';
                    
                    // Check if running locally (localhost or file://)
                    const isLocalhost = window.location.hostname === 'localhost' || 
                                       window.location.hostname === '127.0.0.1' ||
                                       window.location.protocol === 'file:';
                    
                    // Use local API for testing or when explicitly requested
                    if (isTestMode || (isLocalhost && !params.has('use_production_api'))) {
                        return 'http://localhost:8787';
                    }
                    
                    // Default to production API
                    return 'https://grant-search-api.sorrowscry86.workers.dev';
                })(),

                // Initialize
                async init() {
                    console.log('VoidCat Grant App Initializing...');
                    if (this.apiKey) {
                        await this.checkAuth();
                    }
                    // Auto-search on load to show available grants (skip during E2E tests)
                    const params = new URLSearchParams(window.location.search);
                    if (!params.has('e2e_skip_autosearch')) {
                        await this.searchGrants();
                    }
                },

                // Authentication
                async checkAuth() {
                    try {
                        const response = await fetch(`${this.apiBase}/api/users/me`, {
                            headers: {
                                'Authorization': `Bearer ${this.apiKey}`
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.user = data.user;
                            console.log('User authenticated:', this.user);
                        } else {
                            localStorage.removeItem('voidcat_api_key');
                            this.apiKey = null;
                        }
                    } catch (error) {
                        console.error('Auth check failed:', error);
                    }
                },

                // Registration
                async register() {
                    this.registering = true;
                    try {
                        const response = await fetch(`${this.apiBase}/api/users/register`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.registerForm)
                        });
                        const data = await response.json();
                        if (response.ok && (data.api_key || data.token || data.success)) {
                            if (data.api_key) {
                                this.apiKey = data.api_key;
                                {
                                    // Use email as passphrase for encryption
                                    let passphrase = this.registerForm?.email || (this.user?.email);
                                    if (!passphrase) passphrase = window.prompt("Enter an email to protect your API key:");
                                    encryptString(this.apiKey, passphrase).then(enc => {
                                        localStorage.setItem('voidcat_api_key', enc);
                                    });
                                }
                                // Set user data immediately from registration response
                                this.user = {
                                    email: this.registerForm.email,
                                    name: this.registerForm.name,
                                    subscription_tier: data.subscription_tier || 'free',
                                    usage_count: 0
                                };
                                await this.checkAuth(); // This will update with more complete user data
                            } else if (data.token) {
                                this.apiKey = data.token;
                                {
                                    let passphrase = this.registerForm?.email || (this.user?.email);
                                    if (!passphrase) passphrase = window.prompt("Enter an email to protect your token:");
                                    encryptString(this.apiKey, passphrase).then(enc => {
                                        localStorage.setItem('voidcat_api_key', enc);
                                    });
                                }
                                if (data.user) this.user = data.user;
                            } else {
                                // Fallback: set minimal user context for UI when only success is returned
                                this.user = {
                                    email: this.registerForm.email,
                                    name: this.registerForm.name,
                                    subscription_tier: 'free',
                                    usage_count: 0
                                };
                            }
                            this.showNotification('üéâ Registration successful! You can now generate proposals.', 'success');
                        } else {
                            const error = data;
                            console.error('Registration failed:', (error?.error || 'Unknown error'));
                            this.showNotification('‚ùå Registration failed: ' + (error?.error || 'Unknown error'), 'error');
                        }
                    } catch (error) {
                        console.error('Registration failed: ' + error.message);
                        this.showNotification('‚ùå Registration failed: ' + error.message, 'error');
                    } finally {
                        this.registering = false;
                        // Always close modal and clear form after registration attempt
                        this.showRegister = false;
                        this.registerForm = { name: '', email: '', company: '' };
                    }
                },

                // Grant search
                async searchGrants() {
                    this.loading = true;
                    console.log('üîç Starting grant search...');
                    
                    try {
                        const params = new URLSearchParams();
                        if (this.searchQuery) params.append('query', this.searchQuery);
                        if (this.selectedAgency) params.append('agency', this.selectedAgency);

                        console.log('üì° Attempting API call to:', `${this.apiBase}/api/grants/search?${params}`);
                        
                        const response = await fetch(`${this.apiBase}/api/grants/search?${params}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            mode: 'cors'
                        });
                        
                        console.log('üì° API Response status:', response.status);
                        
                        if (!response.ok) {
                            // Handle usage limit reached with upgrade prompt
                            if (response.status === 429) {
                                try {
                                    const err = await response.json();
                                    if (err?.upgrade_required) {
                                        this.showUpgradePrompt = true;
                                        throw new Error(err.message || 'Usage limit reached');
                                    }
                                } catch {}
                            }
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log('üì° API Response data:', data);
                        
                        if (data.success && data.grants) {
                            this.grants = data.grants;
                            this.usingDemoData = false;
                            this.apiConnectionError = null; // Clear any previous errors
                            console.log('‚úÖ Found grants from API:', data.grants.length);

                            // Show success notification if previously had errors
                            if (this.apiConnectionError) {
                                this.showNotification('success', `Connected! Found ${data.grants.length} live grant opportunities.`);
                            }
                        } else {
                            console.error('‚ùå Search failed:', data.error);
                            throw new Error(data.error || 'API returned unsuccessful response');
                        }
                    } catch (error) {
                        console.error('‚ùå Search error:', error.message);
                        console.log('üîÑ Falling back to demo data due to API connectivity issues');

                        // Store error message for user display
                        this.apiConnectionError = `Unable to connect to grant database: ${error.message}. Showing limited demo data.`;

                        // Show notification about API connection issue
                        this.showNotification('warning', 'API connection failed. Showing demo data only. Please try again later.');

                        // Apply filters to demo data if any
                        let filteredGrants = [...this.demoGrants];
                        
                        if (this.searchQuery) {
                            const query = this.searchQuery.toLowerCase();
                            filteredGrants = filteredGrants.filter(grant => 
                                grant.title.toLowerCase().includes(query) ||
                                grant.description.toLowerCase().includes(query) ||
                                grant.program.toLowerCase().includes(query) ||
                                grant.agency.toLowerCase().includes(query)
                            );
                        }
                        
                        if (this.selectedAgency) {
                            const agencyMap = {
                                'defense': 'department of defense',
                                'nsf': 'national science foundation',
                                'energy': 'department of energy',
                                'darpa': 'darpa',
                                'nasa': 'nasa'
                            };
                            const searchAgency = agencyMap[this.selectedAgency.toLowerCase()] || this.selectedAgency.toLowerCase();
                            filteredGrants = filteredGrants.filter(grant => 
                                grant.agency.toLowerCase().includes(searchAgency)
                            );
                        }
                        
                        this.grants = filteredGrants;
                        this.usingDemoData = true;
                        console.log('‚úÖ Using demo data:', filteredGrants.length, 'grants');
                    } finally {
                        this.loading = false;
                        this.searchPerformed = true;
                        console.log('üèÅ Search completed. Total grants:', this.grants.length);
                    }
                },

                // View grant details
                async viewGrant(grantId) {
                    try {
                        const response = await fetch(`${this.apiBase}/api/grants/${grantId}`);
                        const data = await response.json();
                        
                        if (data.success) {
                            const grant = data.grant;
                            const details = `
üìã Grant Details: ${grant.title}

üèõÔ∏è Agency: ${grant.agency}
üí∞ Amount: ${grant.amount}
üìÖ Deadline: ${this.formatDate(grant.deadline)}

üìù Description:
${grant.full_description}

‚úÖ Requirements:
${grant.requirements.map(r => '‚Ä¢ ' + r).join('\n')}

‚öñÔ∏è Evaluation Criteria:
${grant.evaluation_criteria.map(c => '‚Ä¢ ' + c).join('\n')}

üìÑ Submission Requirements:
${grant.submission_requirements.map(s => '‚Ä¢ ' + s).join('\n')}

üìû Contact:
${grant.contact.name}
${grant.contact.email}
${grant.contact.phone}
                            `;
                            this.showGrantDetails(grant);
                        }
                    } catch (error) {
                        console.error('Error viewing grant:', error);
                        this.showError('Error loading grant details. Please try again.');
                    }
                },

                // Generate proposal
                async generateProposal(grantId) {
                    if (!this.user) {
                        this.showRegister = true;
                        return;
                    }

                    // Check usage limits for free users
                    if (this.user.subscription_tier === 'free' && (this.user.usage_count || 0) >= 1) {
                        this.showUpgradePrompt = true;
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiBase}/api/grants/generate-proposal`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.apiKey}`
                            },
                            body: JSON.stringify({
                                grant_id: grantId,
                                company_info: {
                                    name: 'VoidCat RDC',
                                    capabilities: 'AI/ML development, software engineering, federal compliance'
                                }
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            const proposal = data.proposal;
                            const proposalText = `
ü§ñ AI-Generated Proposal Preview

üìù Executive Summary:
${proposal.executive_summary}

üî¨ Technical Approach:
${proposal.technical_approach}

üíº Commercial Potential:
${proposal.commercial_potential}

üí∞ Budget Summary:
‚Ä¢ Personnel: $${proposal.budget_summary.personnel.toLocaleString()}
‚Ä¢ Equipment: $${proposal.budget_summary.equipment.toLocaleString()}
‚Ä¢ Overhead: $${proposal.budget_summary.overhead.toLocaleString()}
‚Ä¢ Total: $${proposal.budget_summary.total.toLocaleString()}

üìÖ Timeline:
${proposal.timeline.map(t => `‚Ä¢ ${t.phase}: ${t.task}`).join('\n')}

Generated at: ${new Date(data.generated_at).toLocaleString()}

Note: This is an AI-generated draft. Review and customize before submission.
                            `;
                            this.showProposal(data);
                        } else {
                            this.showError('Error generating proposal: ' + data.error);
                        }
                    } catch (error) {
                        console.error('Error generating proposal:', error);
                        this.showError('Error generating proposal. Please try again.');
                    }
                },

                // Create Stripe Checkout Session
                async createCheckoutSession() {
                    if (!this.user) {
                        this.showNotification('Please log in to upgrade.', 'warning');
                        this.showRegister = true;
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiBase}/api/stripe/create-checkout`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.apiKey}`
                            },
                            body: JSON.stringify({
                                email: this.user.email
                                // Note: price_id is configured on the backend
                            })
                        });

                        const data = await response.json();
                        const checkoutUrl = data.checkout_url || data.url;
                        const sessionId = data.sessionId || data.session_id;

                        if (checkoutUrl) {
                            window.open(checkoutUrl, '_blank');
                            return;
                        }

                        if (sessionId) {
                            // Initialize Stripe and redirect to checkout
                            const stripe = Stripe('pk_live_YOUR_PUBLISHABLE_KEY_HERE');
                            const result = await stripe.redirectToCheckout({ sessionId });
                            if (result.error) {
                                this.upgradeError = result.error.message || 'Unknown payment error';
                            }
                        } else {
                            this.upgradeError = (data.error?.message || data.error || 'Unknown error');
                        }
                    } catch (error) {
                        console.error('Checkout error:', error);
                        this.upgradeError = error.message || 'Failed to create checkout session';
                    }
                },

                // Modal helper methods for UX overhaul
                showNotification(message, type = 'success') {
                    this.notificationMessage = message;
                    this.notificationType = type;
                    this.showNotificationModal = true;
                    
                    // Auto-hide success notifications after 3 seconds
                    if (type === 'success') {
                        setTimeout(() => {
                            this.showNotificationModal = false;
                        }, 3000);
                    }
                },

                showError(message) {
                    this.errorMessage = message;
                    this.showErrorModal = true;
                },

                showProposal(proposalData) {
                    this.currentProposal = proposalData;
                    this.showProposalModal = true;
                },

                showGrantDetails(grant) {
                    this.currentGrantDetails = grant;
                    this.showGrantDetailsModal = true;
                },

                closeAllModals() {
                    this.showProposalModal = false;
                    this.showGrantDetailsModal = false;
                    this.showNotificationModal = false;
                    this.showErrorModal = false;
                    this.showRegister = false;
                    this.upgradeToProModal = false;
                },

                // Export proposal as Markdown
                exportProposalAsMarkdown() {
                    if (!this.currentProposal) return;
                    
                    const markdownContent = this.currentProposal.proposal || this.currentProposal;
                    const blob = new Blob([markdownContent], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `grant-proposal-${this.currentProposal.grant_id || 'generated'}-${new Date().toISOString().split('T')[0]}.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showNotification('Proposal exported as Markdown file!', 'success');
                },

                // Copy proposal to clipboard
                async copyProposalToClipboard() {
                    if (!this.currentProposal) return;
                    
                    try {
                        const content = this.currentProposal.proposal || this.currentProposal;
                        await navigator.clipboard.writeText(content);
                        this.showNotification('Proposal copied to clipboard!', 'success');
                    } catch (error) {
                        this.showError('Failed to copy to clipboard. Please try selecting and copying manually.');
                    }
                },

                // Utilities
                formatDate(dateString) {
                    return new Date(dateString).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            }
        }
    </script>
</body>
</html>