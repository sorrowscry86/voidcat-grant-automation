name: Deploy VoidCat Grant Automation to GitHub Pages

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Single deploy job since we're just deploying static files
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Validate Frontend Files
        run: |
          echo "🔍 Validating frontend files..."
          if [ ! -f "./frontend/index.html" ]; then
            echo "❌ Error: frontend/index.html not found"
            exit 1
          fi
          if [ ! -f "./frontend/terms-of-service.html" ]; then
            echo "❌ Error: frontend/terms-of-service.html not found"
            exit 1
          fi
          if [ ! -f "./frontend/privacy-policy.html" ]; then
            echo "❌ Error: frontend/privacy-policy.html not found"
            exit 1
          fi
          echo "✅ All required frontend files found"
          
      - name: Test API Connectivity
        run: |
          echo "🔍 Testing API connectivity..."
          API_URL="https://grant-search-api.sorrowscry86.workers.dev"
          
          # Test health endpoint
          if curl -s "$API_URL/health" | grep -q "healthy"; then
            echo "✅ API health check passed"
          else
            echo "⚠️ API health check failed - continuing deployment"
          fi
          
          # Test grant search endpoint
          if curl -s "$API_URL/api/grants/search?query=AI" | grep -q "success"; then
            echo "✅ API grant search working"
          else
            echo "⚠️ API grant search may have issues - continuing deployment"
          fi
        
      - name: Prepare Frontend for Deployment
        run: |
          echo "📁 Preparing frontend files for deployment..."
          # Create a temporary directory for deployment
          mkdir -p ./deploy-temp
          # Copy frontend files to root of deployment directory
          cp -r ./frontend/* ./deploy-temp/
          # Create .nojekyll file to bypass Jekyll processing
          touch ./deploy-temp/.nojekyll
          # List files to verify deployment contents
          echo "📋 Files to be deployed:"
          ls -la ./deploy-temp/
          echo "✅ Frontend files prepared for deployment"
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload the prepared deployment directory
          path: './deploy-temp'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Verify Deployment
        run: |
          echo "🔍 Verifying deployment..."
          DEPLOY_URL="${{ steps.deployment.outputs.page_url }}"
          echo "🌐 Deployment URL: $DEPLOY_URL"
          
          # Wait a moment for deployment to propagate
          sleep 10
          
          # Test the deployed site
          if curl -s "$DEPLOY_URL" | grep -q "VoidCat RDC"; then
            echo "✅ Frontend deployment verified successfully"
          else
            echo "⚠️ Frontend deployment may need time to propagate"
          fi
        
      - name: Deployment Summary
        run: |
          echo "🎯 Frontend Deployment Complete!"
          echo "🌐 Live URL: ${{ steps.deployment.outputs.page_url }}"
          echo "📅 Deployed at: $(date)"
          echo "🔄 Commit: ${{ github.sha }}"
          echo ""
          echo "📊 Platform Status:"
          echo "- Frontend: ✅ Deployed to GitHub Pages"
          echo "- API: https://grant-search-api.sorrowscry86.workers.dev"
          echo ""
          echo "🚀 Ready for user acquisition!"
