name: Deploy VoidCat Grant Automation to GitHub Pages

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Single deploy job since we're just deploying static files
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Validate Frontend Files
        run: |
          echo "ğŸ” Validating frontend files..."
          if [ ! -f "./frontend/index.html" ]; then
            echo "âŒ Error: frontend/index.html not found"
            exit 1
          fi
          if [ ! -f "./frontend/terms-of-service.html" ]; then
            echo "âŒ Error: frontend/terms-of-service.html not found"
            exit 1
          fi
          if [ ! -f "./frontend/privacy-policy.html" ]; then
            echo "âŒ Error: frontend/privacy-policy.html not found"
            exit 1
          fi
          echo "âœ… All required frontend files found"
          
      - name: Test API Connectivity
        run: |
          echo "ğŸ” Testing API connectivity..."
          API_URL="https://grant-search-api.sorrowscry86.workers.dev"
          
          # Test health endpoint
          if curl -s "$API_URL/health" | grep -q "healthy"; then
            echo "âœ… API health check passed"
          else
            echo "âš ï¸ API health check failed - continuing deployment"
          fi
          
          # Test grant search endpoint
          if curl -s "$API_URL/api/grants/search?query=AI" | grep -q "success"; then
            echo "âœ… API grant search working"
          else
            echo "âš ï¸ API grant search may have issues - continuing deployment"
          fi
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload frontend directory
          path: './frontend'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Deployment Summary
        run: |
          echo "ğŸ¯ Frontend Deployment Complete!"
          echo "ğŸŒ Live URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“… Deployed at: $(date)"
          echo "ğŸ”„ Commit: ${{ github.sha }}"
          echo ""
          echo "ğŸ“Š Platform Status:"
          echo "- Frontend: âœ… Deployed to GitHub Pages"
          echo "- API: https://grant-search-api.sorrowscry86.workers.dev"
          echo ""
          echo "ğŸš€ Ready for user acquisition!"
