# Phase 2A API Documentation Update

**Date:** October 3, 2025  
**Version:** Phase 2A Production Ready  
**Status:** Live Documentation for Enhanced Features

## New Environment Variables

### FEATURE_LIVE_DATA
- **Type:** Boolean
- **Default:** false
- **Description:** Enable live federal grant data from Grants.gov and SBIR.gov
- **When enabled:** Uses real external APIs with KV caching
- **When disabled:** Uses mock data for testing and development
- **Production Status:** Disabled (safe rollout strategy)
- **Staging Status:** Enabled (testing environment)

### FEATURE_REAL_AI  
- **Type:** Boolean
- **Default:** false
- **Description:** Enable AI-powered proposal generation
- **Models:** Claude Sonnet 4, GPT-4 Turbo
- **Cost:** ~$0.50 per proposal
- **When disabled:** Uses template-based generation
- **Production Status:** Disabled (safe rollout strategy)
- **Staging Status:** Enabled (testing environment)

## Enhanced Data Sources

### Primary: Grants.gov API (when FEATURE_LIVE_DATA=true)
- **Base URL:** https://api.grants.gov/v1/api/search2
- **Method:** POST
- **Rate Limit:** 120 requests/hour
- **Caching:** 12-hour TTL in KV namespace `FEDERAL_CACHE`
- **Fallback:** SBIR.gov API then mock data
- **Integration:** Multi-source aggregation with deduplication

### Secondary: SBIR.gov API (when FEATURE_LIVE_DATA=true)
- **Base URL:** https://www.sbir.gov/api/opportunities.json  
- **Method:** GET
- **Rate Limit:** 300 requests/hour
- **Caching:** 12-hour TTL in KV namespace `FEDERAL_CACHE`
- **Focus:** SBIR/STTR opportunities specifically
- **Integration:** Merged with Grants.gov results

### Mock Data (when FEATURE_LIVE_DATA=false)
- **Source:** Embedded JSON dataset in DataService
- **Count:** 7 AI-focused grant opportunities
- **Agencies:** DOD, NSF, DARPA, NASA, NIH, DOE
- **Purpose:** Development and testing

## Updated Response Format

### Grant Search Response (Enhanced)

```json
{
  "success": true,
  "count": 7,
  "grants": [
    {
      "id": "SBIR-25-001",
      "title": "AI for Defense Applications",
      "agency": "Department of Defense",
      "program": "SBIR Phase I", 
      "deadline": "2025-09-15",
      "amount": "$250,000",
      "description": "...",
      "eligibility": "Small businesses with <500 employees",
      "matching_score": 0.95,
      "tags": ["AI", "Defense", "Autonomous Systems"],
      "data_source": "mock",
      "opportunity_type": "SBIR",
      "funding_agency_code": "DOD",
      "cfda_number": "12.800"
    }
  ],
  "metadata": {
    "data_source": "mock" | "live",
    "cache_hit": true | false,
    "sources": ["grants.gov", "sbir.gov"] | ["mock"],
    "fallback_occurred": false | true,
    "feature_flags": {
      "live_data": false | true,
      "real_ai": false | true
    },
    "timestamp": "2025-10-03T11:38:18.830Z",
    "live_data_ready": true,
    "search_params": {
      "query": "AI",
      "agency": null,
      "deadline": null,
      "amount": null,
      "program": null,
      "opportunityType": null
    }
  }
}
```

### New Response Fields

**data_source:**
- `"mock"` - Data from embedded mock dataset
- `"live"` - Data from external federal APIs

**cache_hit:**
- `true` - Data served from KV cache (12-hour TTL)
- `false` - Data fetched fresh from external APIs

**sources:**
- Array of data sources used in aggregation
- `["mock"]` - Mock data only
- `["grants.gov", "sbir.gov"]` - Live multi-source

**fallback_occurred:**
- `true` - External APIs failed, using fallback data
- `false` - Successfully used intended data source

**feature_flags:**
- Current status of Phase 2A feature toggles
- Used for debugging and validation

## Enhanced Endpoints

### POST /api/grants/generate-ai-proposal (Phase 2A Enhanced)

**New Feature:** Real AI integration when `FEATURE_REAL_AI=true`

**Request:**
```json
{
  "grant_id": "SBIR-25-001",
  "company_profile": {
    "name": "VoidCat RDC",
    "description": "AI automation platform",
    "industry": "Technology"
  },
  "options": {
    "sections": ["executive_summary", "technical_approach"],
    "length": "detailed"
  }
}
```

**Response (AI-Enhanced):**
```json
{
  "success": true,
  "proposal": {
    "executive_summary": "Generated by Claude Sonnet 4...",
    "technical_approach": "Generated by Claude Sonnet 4...",
    "commercial_potential": "Generated by GPT-4 Turbo...",
    "budget_narrative": "Generated by GPT-4 Turbo...",
    "full_proposal": "Complete proposal text..."
  },
  "generation_details": {
    "ai_enabled": true,
    "models_used": ["claude-sonnet-4", "gpt-4-turbo"],
    "cost": 0.47,
    "tokens": {
      "claude": {"input": 1500, "output": 2000},
      "gpt4": {"input": 1200, "output": 1800}
    }
  },
  "grant_details": {
    "id": "SBIR-25-001",
    "title": "AI for Defense Applications",
    "agency": "Department of Defense"
  }
}
```

**Response (Template Fallback):**
```json
{
  "success": true,
  "proposal": {
    "full_proposal": "Template-based proposal text..."
  },
  "generation_details": {
    "ai_enabled": false,
    "method": "template-based",
    "cost": 0.00
  }
}
```

## Phase 2A Cost Information

### Data Fetching Costs

**Cache Hit (KV):**
- Cost: $0 (served from KV storage)
- Response Time: <100ms
- Expected Hit Rate: 60%+

**Cache Miss (External API):**
- Cost: ~$0.001 per request
- Response Time: 1-3s (with retry logic)
- Automatic caching for 12 hours

**Multi-source Aggregation:**
- Grants.gov + SBIR.gov requests
- Intelligent deduplication 
- Fallback to mock data on failure

### AI Proposal Generation Costs (when FEATURE_REAL_AI=true)

**Claude Sonnet 4:**
- Usage: Executive summaries, technical approaches
- Cost: ~$0.32 per proposal
- Tokens: ~3500 average (1500 input, 2000 output)

**GPT-4 Turbo:**
- Usage: Commercial analysis, budget narratives  
- Cost: ~$0.18 per proposal
- Tokens: ~3000 average (1200 input, 1800 output)

**Total AI Cost:**
- Target: <$0.60 per proposal
- Actual: ~$0.50 per proposal (15% under target)
- Monthly Budget: $2,500 for 5,000 proposals

### Cost Optimization Features

**KV Caching:**
- 60%+ reduction in external API calls
- 12-hour TTL optimized for federal data patterns
- Automatic cache warming for popular queries

**Intelligent Retry Logic:**
- 3 attempts with exponential backoff
- Reduces failed requests and associated costs
- Graceful degradation to fallback data

**Feature Flag Controls:**
- Instant cost controls via environment variables
- Gradual rollout prevents cost spikes
- Emergency rollback capability

## Integration Examples

### Basic Grant Search
```bash
# Mock data (FEATURE_LIVE_DATA=false)
curl "https://grant-search-api.sorrowscry86.workers.dev/api/grants/search?query=AI"

# Live data (FEATURE_LIVE_DATA=true) 
curl "https://grant-search-api-staging.sorrowscry86.workers.dev/api/grants/search?query=AI"
```

### AI Proposal Generation
```bash
# Template-based (FEATURE_REAL_AI=false)
curl -X POST "https://grant-search-api.sorrowscry86.workers.dev/api/grants/generate-ai-proposal" \
  -H "Authorization: Bearer your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "grant_id": "SBIR-25-001",
    "company_profile": {
      "name": "VoidCat RDC",
      "description": "AI automation platform"
    }
  }'

# AI-powered (FEATURE_REAL_AI=true) 
curl -X POST "https://grant-search-api-staging.sorrowscry86.workers.dev/api/grants/generate-ai-proposal" \
  -H "Authorization: Bearer your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "grant_id": "SBIR-25-001", 
    "company_profile": {
      "name": "VoidCat RDC",
      "description": "AI automation platform"
    }
  }'
```

## Environment Configuration

### Development/Local
```toml
[vars]
FEATURE_LIVE_DATA = false
FEATURE_REAL_AI = false
```
- Uses mock data and template-based proposals
- Zero external costs
- Fast development iteration

### Staging
```toml
[env.staging.vars]
FEATURE_LIVE_DATA = true  
FEATURE_REAL_AI = true
```
- Full Phase 2A features enabled
- Real cost monitoring
- Production validation environment

### Production
```toml
[env.production.vars] 
FEATURE_LIVE_DATA = false
FEATURE_REAL_AI = false
```
- Phase 2A features disabled initially
- Safe rollout configuration
- Enable features gradually via deployment

## Gradual Rollout Strategy

### Week 1: Staging Validation
- Monitor all Phase 2A features in staging
- Validate cost projections and performance
- Complete feature testing

### Week 2: Enable FEATURE_LIVE_DATA (Production)
```bash
# Update wrangler.toml
[env.production.vars]
FEATURE_LIVE_DATA = true
FEATURE_REAL_AI = false

# Deploy
npx wrangler deploy --env production
```

### Week 3: Full Live Data Rollout
- Monitor cache hit rates and API performance
- Validate external API reliability
- Measure user satisfaction impact

### Week 4: Enable FEATURE_REAL_AI (Beta Users)
```bash
# Update wrangler.toml  
[env.production.vars]
FEATURE_LIVE_DATA = true
FEATURE_REAL_AI = true

# Deploy
npx wrangler deploy --env production
```

### Week 5: Full Production Rollout
- All Phase 2A features enabled
- Complete cost and performance validation
- Success metrics achieved

## Monitoring & Alerts

### Key Metrics
- AI cost per proposal: <$0.60
- Cache hit rate: >60%
- API success rate: >95%
- Response time p95: <3s

### Alert Thresholds
- Daily AI costs > $100 (Critical)
- Cache hit rate < 40% for 1 hour (Warning)
- API success rate < 80% for 15 minutes (Critical)

### Rollback Procedure
```bash
# Emergency rollback - disable all Phase 2A features
[env.production.vars]
FEATURE_LIVE_DATA = false
FEATURE_REAL_AI = false

# Deploy immediately
npx wrangler deploy --env production --force
```

## Support & Contact

**Project:** VoidCat RDC Federal Grant Automation Platform  
**Phase:** 2A - Production Reality Integration  
**Developer:** @sorrowscry86  
**Contact:** SorrowsCry86@voidcat.org  
**Organization:** VoidCat RDC  

**Documentation:**
- Phase 2A Implementation: Basic Memory `voidcat-rdc/grants/`
- Monitoring Guide: `docs/PHASE-2A-MONITORING.md`
- Deployment Guide: `docs/deployment/DEPLOYMENT.md`

**Environments:**
- Production: https://grant-search-api.sorrowscry86.workers.dev
- Staging: https://grant-search-api-staging.sorrowscry86.workers.dev

---

**Last Updated:** October 3, 2025  
**Version:** Phase 2A Complete  
**Status:** Production Ready with Safe Rollout Configuration